<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Status Tracker</title>
  <link rel="icon" type="image/png" href="data:image/png;base64,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">

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getDatabase, ref, child, get } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyASIJauTTobtyVe2Ff3KMzo-RTAwy6cOPc",
    authDomain: "medtech--api.firebaseapp.com",
    databaseURL: "https://medtech--api-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "medtech--api",
    storageBucket: "medtech--api.firebasestorage.app",
    messagingSenderId: "246226348117",
    appId: "1:246226348117:web:ab8471e22a10ace7104cdc"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);

  // Expose these for non-module scripts
  window.database = database;
  window.ref = ref;
  window.child = child;
  window.get = get;
</script>
  
  <style>
    body {
      background-color: #000;
      color: white;
      font-family: Arial, sans-serif;
      padding: 30px;
    }
    h1 {
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #444;
      text-align: center;
    }
    th {
      background-color: #222;
    }
    td a, td button {
      background-color: #007BFF;
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
    }
    td a:hover, td button:hover {
      background-color: #0056b3;
    }
    .tick {
      color: #28a745;
      font-size: 20px;
    }
    .cross {
      color: #dc3545;
      font-size: 20px;
    }

    /* Spinner styles */
    .word-spinner {
      display: none;
      margin-left: 8px;
    }
    .spinner-icon {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007BFF;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h1>Status Tracker</h1>
  <table id="statusTable">
    <thead>
      <tr>
        <th>Device Name</th>
        <th>Finalized By</th>
        <th>Date</th>
        <th>DI</th>
        <th>DO</th>
        <th>Download Word - Design Input</th>
        <th>Open DO</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  
  <script>
    let data = [];

async function loadData() {
  try {
    const dbRef = ref(database, 'devices');
    const snapshot = await get(dbRef);
    if (!snapshot.exists()) {
      throw new Error("No data available");
    }
    const firebaseData = snapshot.val();
    data = Object.values(firebaseData);
    renderTable();
  } catch (err) {
    console.error("Load failed:", err);
    const tbody = document.querySelector("#statusTable tbody");
    tbody.innerHTML = `<tr><td colspan="7">Error loading data</td></tr>`;
  }
}
    function renderTable() {
      const tbody = document.querySelector("#statusTable tbody");
      tbody.innerHTML = "";

      if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7">No finalized devices found.</td></tr>`;
        return;
      }

      data.forEach((item, index) => {
        const tr = document.createElement("tr");
        const tick = '<span class="tick">✔</span>';
        const cross = '<span class="cross">✘</span>';

        tr.innerHTML = `
          <td>${item.deviceName}</td>
          <td>${item.finalizedBy}</td>
          <td>${new Date(item.finalizedAt).toLocaleString()}</td>
          <td>${item.diComplete ? tick : cross}</td>
          <td>${item.doComplete ? tick : cross}</td>
          <td>
            <button onclick="downloadWordFromStatus(${index})" id="downloadBtn${index}">
              Download Word
              <span class="word-spinner" id="spinner${index}">
                <span class="spinner-icon"></span>
              </span>
            </button>
          </td>
          <td>
            <button onclick="openDO(${index})">Open DO</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function openDO(index) {
      localStorage.setItem("selectedDeviceIndex", index);
      window.location.href = "DO.html";
    }

    async function downloadWordFromStatus(index) {
      const device = data[index];
      const sections = extractSectionsFromHTML(device.designInputHtml);
      const spinner = document.getElementById(`spinner${index}`);
      const btn = document.getElementById(`downloadBtn${index}`);

      spinner.style.display = "inline-block";
      btn.disabled = true;

      try {
        const res = await fetch("https://medtech-api-jjqj.onrender.com/generate-docx", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            deviceName: device.deviceName,
            intendedUse: device.intendedUse,
            sections: sections,
          }),
        });

        if (!res.ok) throw new Error("Failed to generate Word document");

        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `Design_Input_${device.deviceName.replace(/\s+/g, "_")}.docx`;
        a.click();
        window.URL.revokeObjectURL(url);
      } catch (err) {
        alert("Error generating Word file.");
        console.error(err);
      } finally {
        spinner.style.display = "none";
        btn.disabled = false;
      }
    }

    function extractSectionsFromHTML(html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");
      const headings = doc.querySelectorAll("h3 strong");
      return Array.from(headings).map(h => h.innerText.trim());
    }

async function saveDeviceToFirebase(device) {
  const deviceRef = database.ref('devices').push();
  await deviceRef.set({
    deviceName: device.deviceName,
    finalizedBy: device.finalizedBy,
    finalizedAt: device.finalizedAt,
    diComplete: device.diComplete,
    doComplete: device.doComplete,
    intendedUse: device.intendedUse,
    designInputHtml: device.designInputHtml
  });
}   
    window.onload = loadData;
  </script>
</body>
</html>
